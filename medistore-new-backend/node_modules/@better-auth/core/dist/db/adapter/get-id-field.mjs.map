{"version":3,"file":"get-id-field.mjs","names":["shouldGenerateId: boolean","generateId","defaultGenerateId"],"sources":["../../../src/db/adapter/get-id-field.ts"],"sourcesContent":["import { logger } from \"../../env\";\nimport type { BetterAuthOptions } from \"../../types\";\nimport { generateId as defaultGenerateId } from \"../../utils\";\nimport type { BetterAuthDBSchema, DBFieldAttribute } from \"../type\";\nimport { initGetDefaultModelName } from \"./get-default-model-name\";\n\nexport const initGetIdField = ({\n\tusePlural,\n\tschema,\n\tdisableIdGeneration,\n\toptions,\n\tcustomIdGenerator,\n\tsupportsUUIDs,\n}: {\n\tusePlural?: boolean;\n\tschema: BetterAuthDBSchema;\n\toptions: BetterAuthOptions;\n\tdisableIdGeneration?: boolean;\n\tcustomIdGenerator?: ((props: { model: string }) => string) | undefined;\n\tsupportsUUIDs?: boolean;\n}) => {\n\tconst getDefaultModelName = initGetDefaultModelName({\n\t\tusePlural: usePlural,\n\t\tschema,\n\t});\n\n\tconst idField = ({\n\t\tcustomModelName,\n\t\tforceAllowId,\n\t}: {\n\t\tcustomModelName?: string;\n\t\tforceAllowId?: boolean;\n\t}) => {\n\t\tconst useNumberId =\n\t\t\toptions.advanced?.database?.useNumberId ||\n\t\t\toptions.advanced?.database?.generateId === \"serial\";\n\t\tconst useUUIDs = options.advanced?.database?.generateId === \"uuid\";\n\n\t\tconst shouldGenerateId: boolean = (() => {\n\t\t\tif (disableIdGeneration) {\n\t\t\t\treturn false;\n\t\t\t} else if (useNumberId && !forceAllowId) {\n\t\t\t\t// if force allow is true, then we should be using their custom provided id.\n\t\t\t\treturn false;\n\t\t\t} else if (useUUIDs) {\n\t\t\t\t// should only generate UUIDs via JS if the database doesn't support natively generating UUIDs.\n\t\t\t\treturn !supportsUUIDs;\n\t\t\t} else {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t})();\n\n\t\tconst model = getDefaultModelName(customModelName ?? \"id\");\n\t\treturn {\n\t\t\ttype: useNumberId ? \"number\" : \"string\",\n\t\t\trequired: shouldGenerateId ? true : false,\n\t\t\t...(shouldGenerateId\n\t\t\t\t? {\n\t\t\t\t\t\tdefaultValue() {\n\t\t\t\t\t\t\tif (disableIdGeneration) return undefined;\n\t\t\t\t\t\t\tconst generateId = options.advanced?.database?.generateId;\n\t\t\t\t\t\t\tif (generateId === false || useNumberId) return undefined;\n\t\t\t\t\t\t\tif (typeof generateId === \"function\") {\n\t\t\t\t\t\t\t\treturn generateId({\n\t\t\t\t\t\t\t\t\tmodel,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (customIdGenerator) {\n\t\t\t\t\t\t\t\treturn customIdGenerator({ model });\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (generateId === \"uuid\") {\n\t\t\t\t\t\t\t\treturn crypto.randomUUID();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\treturn defaultGenerateId();\n\t\t\t\t\t\t},\n\t\t\t\t\t}\n\t\t\t\t: {}),\n\t\t\ttransform: {\n\t\t\t\tinput: (value) => {\n\t\t\t\t\t// Uncomment if need to debug id transformation\n\t\t\t\t\t// console.log(`transforming id: `, {\n\t\t\t\t\t// \tid: value,\n\t\t\t\t\t// \t...(useNumberId ? { useNumberId } : {}),\n\t\t\t\t\t// \t...(useUUIDs ? { useUUIDs } : {}),\n\t\t\t\t\t// \t...(forceAllowId ? { forceAllowId } : {}),\n\t\t\t\t\t// });\n\t\t\t\t\tif (!value) return undefined;\n\n\t\t\t\t\tif (useNumberId) {\n\t\t\t\t\t\tconst numberValue = Number(value);\n\t\t\t\t\t\t// if invalid number, fallback to DB generated number id.\n\t\t\t\t\t\tif (isNaN(numberValue)) {\n\t\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn numberValue;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (useUUIDs) {\n\t\t\t\t\t\t// if it's generated by us, then we should return the value as is.\n\t\t\t\t\t\tif (shouldGenerateId && !forceAllowId) return value;\n\t\t\t\t\t\tif (disableIdGeneration) return undefined;\n\t\t\t\t\t\t// if DB will handle UUID generation, then we should return undefined.\n\t\t\t\t\t\tif (supportsUUIDs) return undefined;\n\t\t\t\t\t\t// if forceAllowId is true, it means we should be using the ID provided during the adapter call.\n\t\t\t\t\t\tif (forceAllowId && typeof value === \"string\") {\n\t\t\t\t\t\t\tconst uuidRegex =\n\t\t\t\t\t\t\t\t/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;\n\t\t\t\t\t\t\tif (uuidRegex.test(value)) {\n\t\t\t\t\t\t\t\treturn value;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tconst err = new Error();\n\t\t\t\t\t\t\t\tconst stack = err.stack\n\t\t\t\t\t\t\t\t\t?.split(\"\\n\")\n\t\t\t\t\t\t\t\t\t.filter((_, i) => i !== 1)\n\t\t\t\t\t\t\t\t\t.join(\"\\n\")\n\t\t\t\t\t\t\t\t\t.replace(\"Error:\", \"\");\n\t\t\t\t\t\t\t\tlogger.warn(\n\t\t\t\t\t\t\t\t\t\"[Adapter Factory] - Invalid UUID value for field `id` provided when `forceAllowId` is true. Generating a new UUID.\",\n\t\t\t\t\t\t\t\t\tstack,\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// if the value is not a string, and the database doesn't support generating it's own UUIDs, then we should be generating the UUID.\n\t\t\t\t\t\tif (typeof value !== \"string\" && !supportsUUIDs) {\n\t\t\t\t\t\t\treturn crypto.randomUUID();\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn value;\n\t\t\t\t},\n\t\t\t\toutput: (value) => {\n\t\t\t\t\tif (!value) return undefined;\n\t\t\t\t\treturn String(value);\n\t\t\t\t},\n\t\t\t},\n\t\t} satisfies DBFieldAttribute;\n\t};\n\n\treturn idField;\n};\n"],"mappings":";;;;;;;AAMA,MAAa,kBAAkB,EAC9B,WACA,QACA,qBACA,SACA,mBACA,oBAQK;CACL,MAAM,sBAAsB,wBAAwB;EACxC;EACX;EACA,CAAC;CAEF,MAAM,WAAW,EAChB,iBACA,mBAIK;EACL,MAAM,cACL,QAAQ,UAAU,UAAU,eAC5B,QAAQ,UAAU,UAAU,eAAe;EAC5C,MAAM,WAAW,QAAQ,UAAU,UAAU,eAAe;EAE5D,MAAMA,0BAAmC;AACxC,OAAI,oBACH,QAAO;YACG,eAAe,CAAC,aAE1B,QAAO;YACG,SAEV,QAAO,CAAC;OAER,QAAO;MAEL;EAEJ,MAAM,QAAQ,oBAAoB,mBAAmB,KAAK;AAC1D,SAAO;GACN,MAAM,cAAc,WAAW;GAC/B,UAAU,mBAAmB,OAAO;GACpC,GAAI,mBACD,EACA,eAAe;AACd,QAAI,oBAAqB,QAAO;IAChC,MAAMC,eAAa,QAAQ,UAAU,UAAU;AAC/C,QAAIA,iBAAe,SAAS,YAAa,QAAO;AAChD,QAAI,OAAOA,iBAAe,WACzB,QAAOA,aAAW,EACjB,OACA,CAAC;AAEH,QAAI,kBACH,QAAO,kBAAkB,EAAE,OAAO,CAAC;AAEpC,QAAIA,iBAAe,OAClB,QAAO,OAAO,YAAY;AAE3B,WAAOC,YAAmB;MAE3B,GACA,EAAE;GACL,WAAW;IACV,QAAQ,UAAU;AAQjB,SAAI,CAAC,MAAO,QAAO;AAEnB,SAAI,aAAa;MAChB,MAAM,cAAc,OAAO,MAAM;AAEjC,UAAI,MAAM,YAAY,CACrB;AAED,aAAO;;AAGR,SAAI,UAAU;AAEb,UAAI,oBAAoB,CAAC,aAAc,QAAO;AAC9C,UAAI,oBAAqB,QAAO;AAEhC,UAAI,cAAe,QAAO;AAE1B,UAAI,gBAAgB,OAAO,UAAU,SAGpC,KADC,6EACa,KAAK,MAAM,CACxB,QAAO;WACD;OAEN,MAAM,yBADM,IAAI,OAAO,EACL,OACf,MAAM,KAAK,CACZ,QAAQ,GAAG,MAAM,MAAM,EAAE,CACzB,KAAK,KAAK,CACV,QAAQ,UAAU,GAAG;AACvB,cAAO,KACN,sHACA,MACA;;AAIH,UAAI,OAAO,UAAU,YAAY,CAAC,cACjC,QAAO,OAAO,YAAY;AAE3B;;AAGD,YAAO;;IAER,SAAS,UAAU;AAClB,SAAI,CAAC,MAAO,QAAO;AACnB,YAAO,OAAO,MAAM;;IAErB;GACD;;AAGF,QAAO"}